<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced DFA Learning Studio</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2d3748;
      overflow-x: hidden;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header h1 {
      font-size: 2.8rem;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
      text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }

    .header p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
      font-weight: 300;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 25px;
      flex: 1;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      height: fit-content;
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .visualization-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #4a5568;
    }

    select, input, button {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .button-group button {
      margin-bottom: 0;
    }

    .variations-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .variation-card {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .variation-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .variation-card.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .variation-title {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .variation-desc {
      font-size: 0.8rem;
      opacity: 0.7;
      line-height: 1.3;
    }

    .guide-panel {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      min-height: 100px;
      display: flex;
      align-items: center;
    }

    .guide-content {
      line-height: 1.6;
      font-size: 1rem;
    }

    .construction-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .construction-controls button {
      flex: 1;
      min-width: 120px;
      margin-bottom: 0;
    }

    .auto-play-control {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      color: #4a5568;
    }

    .auto-play-control input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .svg-container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      border: 2px solid #e2e8f0;
      margin-bottom: 20px;
      flex: 1;
      min-height: 400px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #dfaSVG {
      max-width: 100%;
      height: auto;
      min-height: 350px;
    }

    .test-panel {
      background: #f7fafc;
      padding: 20px;
      border-radius: 15px;
      border: 2px solid #e2e8f0;
    }

    .test-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .test-controls input {
      flex: 2;
      min-width: 200px;
    }

    .test-controls button {
      flex: 1;
      min-width: 100px;
      margin-bottom: 0;
    }

    .output-display {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      padding: 15px;
      min-height: 50px;
      font-weight: 600;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .output-display.success {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border-color: #38a169;
    }

    .output-display.error {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      color: white;
      border-color: #e53e3e;
    }

    .output-display.info {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      border-color: #3182ce;
    }

    /* SVG Styles */
    .state-circle {
      fill: #f7fafc;
      stroke: #4299e1;
      stroke-width: 2.5;
      transition: all 0.3s ease;
    }

    .state-circle.final {
      stroke: #48bb78;
      stroke-width: 3;
    }

    .state-circle.active {
      fill: #ffd32a;
      stroke: #f6ad55;
      stroke-width: 3;
      filter: drop-shadow(0 0 10px rgba(255, 211, 42, 0.5));
    }

    .state-label {
      font-size: 16px;
      font-weight: 700;
      fill: #2d3748;
      text-anchor: middle;
      dominant-baseline: central;
    }

    .transition-path {
      fill: none;
      stroke: #4299e1;
      stroke-width: 2;
      transition: all 0.3s ease;
    }

    .transition-path.active {
      stroke: #f6ad55;
      stroke-width: 4;
      filter: drop-shadow(0 0 5px rgba(246, 173, 85, 0.5));
    }

    .transition-label {
      font-size: 14px;
      font-weight: 600;
      fill: #2d3748;
      text-anchor: middle;
    }

    .initial-arrow {
      stroke: #e53e3e;
      stroke-width: 3;
      fill: none;
    }

    /* Custom Builder Styles */
    .builder-panel {
      background: #f7fafc;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #e2e8f0;
    }

    .builder-hidden {
      display: none;
    }

    .state-input, .transition-input {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .transition-input {
      grid-template-columns: 1fr 1fr 1fr;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 20px;
      width: 80%;
      max-width: 500px;
      position: relative;
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 30px;
      cursor: pointer;
      color: #666;
    }

    .close:hover {
      color: #000;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .control-panel {
        position: static;
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
      }

      .header h1 {
        font-size: 2.2rem;
      }

      .header {
        padding: 20px;
        margin-bottom: 20px;
      }

      .control-panel, .visualization-panel {
        padding: 20px;
      }

      .construction-controls {
        flex-direction: column;
      }

      .test-controls {
        flex-direction: column;
      }

      .test-controls input,
      .test-controls button {
        width: 100%;
        margin-bottom: 10px;
      }

      #dfaSVG {
        width: 100%;
        min-height: 300px;
      }

      .button-group {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .control-panel, .visualization-panel {
        padding: 15px;
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Pulse Animation for Active Elements */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Success/Error Animations */
    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .animate-result {
      animation: slideInUp 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <h1>üöÄ Advanced DFA Learning Studio</h1>
      <p>Professional-grade interactive visualization and learning tool for Deterministic Finite Automata</p>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Control Panel -->
      <div class="control-panel">
        <h2 class="section-title">üéõÔ∏è Control Panel</h2>
        
        <div class="form-group">
          <label for="dfaCategory">Select DFA Category:</label>
          <select id="dfaCategory">
            <option value="">Choose a category...</option>
          </select>
        </div>

        <div id="variationsContainer" style="display: none;">
          <label>üìö Available Variations:</label>
          <div class="variations-grid" id="variationsGrid"></div>
        </div>

        <div class="form-group">
          <label>üé¨ Construction Animation:</label>
          <div class="construction-controls">
            <button id="prevStepBtn" disabled>‚¨ÖÔ∏è Previous</button>
            <button id="nextStepBtn" disabled>Next ‚û°Ô∏è</button>
            <button id="restartStepsBtn" disabled>üîÑ Restart</button>
          </div>
          <div class="auto-play-control">
            <input type="checkbox" id="autoPlayToggle" checked>
            <label for="autoPlayToggle">Auto-play construction steps</label>
          </div>
        </div>

        <div class="form-group">
          <label>üß™ String Testing:</label>
          <div class="test-controls">
            <input id="testInput" placeholder="Enter test string (a,b)" maxlength="50">
            <button id="testBtn">üéÆ Test</button>
            <button id="resetBtn">üîÑ Reset</button>
          </div>
        </div>

        <div class="form-group">
          <label>‚ö° Quick Actions:</label>
          <div class="button-group">
            <button id="randomTestBtn">üé≤ Random</button>
            <button id="stepModeBtn">üë£ Step Mode</button>
          </div>
          <div class="button-group">
            <button id="fullSpeedBtn">‚ö° Fast</button>
            <button id="slowSpeedBtn">üêå Slow</button>
          </div>
        </div>

        <div class="form-group">
          <label>üîß Advanced Features:</label>
          <div class="button-group">
            <button id="customBuilderBtn">üõ†Ô∏è Builder</button>
            <button id="exportBtn">üì§ Export</button>
          </div>
          <div class="button-group">
            <button id="saveBtn">üíæ Save</button>
            <button id="loadBtn">üìÇ Load</button>
          </div>
        </div>
      </div>

      <!-- Visualization Panel -->
      <div class="visualization-panel">
        <h2 class="section-title">üìä DFA Visualization</h2>
        
        <div class="guide-panel" id="guidePanel">
          <div class="guide-content" id="guideContent">
            üéØ Select a DFA category and variation to begin learning!
          </div>
        </div>

        <!-- Custom Builder Panel (Hidden by default) -->
        <div class="builder-panel builder-hidden" id="builderPanel">
          <h3>üõ†Ô∏è Custom DFA Builder</h3>
          <div class="form-group">
            <label>Add State:</label>
            <div class="state-input">
              <input id="stateId" placeholder="State ID (e.g., q0)">
              <button id="addStateBtn">‚ûï Add State</button>
            </div>
            <div class="button-group">
              <button id="setInitialBtn" disabled>üéØ Set Initial</button>
              <button id="toggleAcceptingBtn" disabled>‚úÖ Toggle Accept</button>
            </div>
          </div>
          <div class="form-group">
            <label>Add Transition:</label>
            <div class="transition-input">
              <input id="fromState" placeholder="From state">
              <input id="toState" placeholder="To state">
              <input id="transitionSymbol" placeholder="Symbol">
            </div>
            <button id="addTransitionBtn">‚ûï Add Transition</button>
          </div>
          <div class="button-group">
            <button id="clearDfaBtn">üóëÔ∏è Clear All</button>
            <button id="validateDfaBtn">‚úÖ Validate</button>
          </div>
        </div>

        <div class="svg-container">
          <svg id="dfaSVG" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                      refX="10" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#4299e1" />
              </marker>
              <marker id="arrowhead-active" markerWidth="10" markerHeight="7" 
                      refX="10" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#f6ad55" />
              </marker>
            </defs>
            <text x="400" y="200" text-anchor="middle" class="state-label" 
                  style="font-size: 18px; fill: #a0aec0;">
              Select a DFA to visualize
            </text>
          </svg>
        </div>

        <div class="test-panel">
          <h3 style="margin-bottom: 15px; color: #4a5568;">üéØ Test Results</h3>
          <div class="output-display" id="outputDisplay">
            Ready to test your DFA knowledge!
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save/Load Modal -->
  <div id="saveLoadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle">Save DFA</h3>
      <div class="form-group">
        <label for="dfaName">DFA Name:</label>
        <input id="dfaName" placeholder="Enter a name for your DFA">
      </div>
      <div class="form-group">
        <label for="dfaData">DFA Data (JSON):</label>
        <textarea id="dfaData" rows="10" style="width: 100%; font-family: monospace;"></textarea>
      </div>
      <div class="button-group">
        <button id="confirmSaveLoad">Save</button>
        <button id="cancelSaveLoad">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let CURRENT_DFA = null;
    let STATE_POSITIONS = {};
    let ANIMATION_GENERATOR = null;
    let CONSTRUCTION_STEPS = null;
    let CURRENT_STEP = -1;
    let AUTO_PLAY = true;
    let STEP_TIMEOUT = null;
    let ANIMATION_SPEED = 1000;
    let BUILDER_MODE = false;
    let SELECTED_STATE = null;

    // DOM elements
    const dfaCategory = document.getElementById('dfaCategory');
    const variationsContainer = document.getElementById('variationsContainer');
    const variationsGrid = document.getElementById('variationsGrid');
    const guideContent = document.getElementById('guideContent');
    const outputDisplay = document.getElementById('outputDisplay');
    const testInput = document.getElementById('testInput');
    const dfaSVG = document.getElementById('dfaSVG');
    const builderPanel = document.getElementById('builderPanel');

    // Comprehensive DFA Library - All Valid Regular Languages
    const DFA_LIBRARY = {
      'basic-patterns': {
        name: 'üî§ Basic String Patterns',
        dfas: [
          {
            name: 'Starts with "a"',
            description: 'Accept strings that begin with "a"',
            states: [
              { id: 'q0', x: 150, y: 200, initial: true },
              { id: 'q1', x: 350, y: 200, accepting: true },
              { id: 'q2', x: 550, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q2', symbol: 'b' },
              { from: 'q1', to: 'q1', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' },
              { from: 'q2', to: 'q2', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create initial state q0',
              'Add accepting state q1 for strings starting with "a"',
              'Add trap state q2 for strings starting with "b"',
              'Add transition q0 ‚Üí q1 on "a"',
              'Add transition q0 ‚Üí q2 on "b"',
              'Add self-loops on q1 and q2 for all symbols'
            ]
          },
          {
            name: 'Ends with "b"',
            description: 'Accept strings that end with "b"',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true },
              { id: 'q1', x: 500, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q0', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q0', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create initial state q0',
              'Add accepting state q1 for strings ending with "b"',
              'Add transition q0 ‚Üí q1 on "b"',
              'Add transition q1 ‚Üí q0 on "a" (reset)',
              'Add self-loops for tracking last character'
            ]
          },
          {
            name: 'Contains "ab"',
            description: 'Accept strings containing substring "ab"',
            states: [
              { id: 'q0', x: 150, y: 200, initial: true },
              { id: 'q1', x: 350, y: 200 },
              { id: 'q2', x: 550, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q1', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q1', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create initial state q0',
              'Add state q1 to track "a"',
              'Add accepting state q2 for "ab" found',
              'Add transition q0 ‚Üí q1 on "a"',
              'Add transition q1 ‚Üí q2 on "b"',
              'Handle remaining transitions'
            ]
          },
          {
            name: 'Exactly one "a"',
            description: 'Accept strings with exactly one "a"',
            states: [
              { id: 'q0', x: 150, y: 200, initial: true },
              { id: 'q1', x: 350, y: 200, accepting: true },
              { id: 'q2', x: 550, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' },
              { from: 'q2', to: 'q2', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create initial state q0 (zero "a"s)',
              'Add accepting state q1 (one "a")',
              'Add trap state q2 (more than one "a")',
              'Transition between states counting "a"s',
              'Stay in current state on "b"'
            ]
          }
        ]
      },
      'length-patterns': {
        name: 'üìè Length-Based Patterns',
        dfas: [
          {
            name: 'Even Length',
            description: 'Accept strings with even number of characters',
            states: [
              { id: 'q0', x: 250, y: 200, initial: true, accepting: true },
              { id: 'q1', x: 450, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q0', symbol: 'a' },
              { from: 'q1', to: 'q0', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create state q0 for even length (including 0)',
              'Create state q1 for odd length',
              'Mark q0 as accepting',
              'Toggle between states on each character'
            ]
          },
          {
            name: 'Odd Length',
            description: 'Accept strings with odd number of characters',
            states: [
              { id: 'q0', x: 250, y: 200, initial: true },
              { id: 'q1', x: 450, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q0', symbol: 'a' },
              { from: 'q1', to: 'q0', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create state q0 for even length',
              'Create state q1 for odd length',
              'Mark q1 as accepting',
              'Toggle between states on each character'
            ]
          },
          {
            name: 'Length divisible by 3',
            description: 'Accept strings whose length ‚â° 0 (mod 3)',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true, accepting: true },
              { id: 'q1', x: 400, y: 150 },
              { id: 'q2', x: 400, y: 250 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q0', symbol: 'a' },
              { from: 'q2', to: 'q0', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create states for length mod 3',
              'q0: length ‚â° 0 (mod 3)',
              'q1: length ‚â° 1 (mod 3)',
              'q2: length ‚â° 2 (mod 3)',
              'Cycle: q0 ‚Üí q1 ‚Üí q2 ‚Üí q0'
            ]
          },
          {
            name: 'Length between 2 and 4',
            description: 'Accept strings with length 2, 3, or 4',
            states: [
              { id: 'q0', x: 100, y: 200, initial: true },
              { id: 'q1', x: 250, y: 200 },
              { id: 'q2', x: 400, y: 200, accepting: true },
              { id: 'q3', x: 550, y: 200, accepting: true },
              { id: 'q4', x: 700, y: 200, accepting: true },
              { id: 'q5', x: 400, y: 300 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q3', symbol: 'a' },
              { from: 'q2', to: 'q3', symbol: 'b' },
              { from: 'q3', to: 'q4', symbol: 'a' },
              { from: 'q3', to: 'q4', symbol: 'b' },
              { from: 'q4', to: 'q5', symbol: 'a' },
              { from: 'q4', to: 'q5', symbol: 'b' },
              { from: 'q5', to: 'q5', symbol: 'a' },
              { from: 'q5', to: 'q5', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Create states to count exact length',
              'States q2, q3, q4 are accepting',
              'q5 is trap for length > 4',
              'Track length precisely'
            ]
          }
        ]
      },
      'counting-patterns': {
        name: 'üßÆ Counting Patterns (Modular)',
        dfas: [
          {
            name: 'Even number of "a"s',
            description: 'Accept strings with even count of "a"',
            states: [
              { id: 'q0', x: 250, y: 200, initial: true, accepting: true },
              { id: 'q1', x: 450, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q0', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'q0: even count of "a" (accepting)',
              'q1: odd count of "a"',
              'Toggle on "a", stay same on "b"',
              'Track parity of "a" count'
            ]
          },
          {
            name: 'At most two "b"s',
            description: 'Accept strings with ‚â§ 2 occurrences of "b"',
            states: [
              { id: 'q0', x: 150, y: 200, initial: true, accepting: true },
              { id: 'q1', x: 300, y: 200, accepting: true },
              { id: 'q2', x: 450, y: 200, accepting: true },
              { id: 'q3', x: 600, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q0', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q1', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q2', symbol: 'a' },
              { from: 'q2', to: 'q3', symbol: 'b' },
              { from: 'q3', to: 'q3', symbol: 'a' },
              { from: 'q3', to: 'q3', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Count "b"s up to 2',
              'q0: 0 "b"s, q1: 1 "b", q2: 2 "b"s',
              'q3: more than 2 "b"s (trap)',
              'Stay same on "a"'
            ]
          },
          {
            name: 'Count of "a"s divisible by 3',
            description: 'Accept when #a ‚â° 0 (mod 3)',
            states: [
              { id: 'q0', x: 250, y: 150, initial: true, accepting: true },
              { id: 'q1', x: 150, y: 250 },
              { id: 'q2', x: 350, y: 250 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' },
              { from: 'q2', to: 'q0', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track count of "a" modulo 3',
              'Cycle q0 ‚Üí q1 ‚Üí q2 ‚Üí q0 on "a"',
              'Stay same on "b"',
              'Only q0 is accepting'
            ]
          },
          {
            name: 'Exactly three "a"s',
            description: 'Accept strings with exactly 3 "a"s',
            states: [
              { id: 'q0', x: 120, y: 200, initial: true },
              { id: 'q1', x: 250, y: 200 },
              { id: 'q2', x: 380, y: 200 },
              { id: 'q3', x: 510, y: 200, accepting: true },
              { id: 'q4', x: 640, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q1', symbol: 'b' },
              { from: 'q2', to: 'q3', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' },
              { from: 'q3', to: 'q4', symbol: 'a' },
              { from: 'q3', to: 'q3', symbol: 'b' },
              { from: 'q4', to: 'q4', symbol: 'a' },
              { from: 'q4', to: 'q4', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Count "a"s exactly',
              'States represent 0,1,2,3,>3 "a"s',
              'Only q3 (exactly 3) is accepting',
              'q4 is trap for too many "a"s'
            ]
          }
        ]
      },
      'substring-patterns': {
        name: 'üîç Substring Patterns',
        dfas: [
          {
            name: 'Contains "aba"',
            description: 'Accept strings containing "aba"',
            states: [
              { id: 'q0', x: 120, y: 200, initial: true },
              { id: 'q1', x: 280, y: 200 },
              { id: 'q2', x: 440, y: 200 },
              { id: 'q3', x: 600, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q1', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q3', symbol: 'a' },
              { from: 'q2', to: 'q0', symbol: 'b' },
              { from: 'q3', to: 'q1', symbol: 'a' },
              { from: 'q3', to: 'q3', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track progress toward "aba"',
              'q1: saw "a", q2: saw "ab"',
              'q3: found "aba" (accepting)',
              'Handle overlapping patterns correctly'
            ]
          },
          {
            name: 'Contains "bb"',
            description: 'Accept strings containing "bb"',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true },
              { id: 'q1', x: 400, y: 200 },
              { id: 'q2', x: 600, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q0', symbol: 'a' },
              { from: 'q0', to: 'q1', symbol: 'b' },
              { from: 'q1', to: 'q0', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q0', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track consecutive "b"s',
              'q1: saw one "b"',
              'q2: found "bb" (accepting)',
              'Reset tracking on "a"'
            ]
          },
          {
            name: 'Ends with "ab"',
            description: 'Accept strings ending with "ab"',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true },
              { id: 'q1', x: 400, y: 200 },
              { id: 'q2', x: 600, y: 200, accepting: true }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q1', symbol: 'a' },
              { from: 'q1', to: 'q2', symbol: 'b' },
              { from: 'q2', to: 'q1', symbol: 'a' },
              { from: 'q2', to: 'q0', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track last two characters',
              'q1: ends with "a"',
              'q2: ends with "ab" (accepting)',
              'Update based on new character'
            ]
          },
          {
            name: 'Does not contain "aa"',
            description: 'Accept strings without "aa"',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true, accepting: true },
              { id: 'q1', x: 400, y: 200, accepting: true },
              { id: 'q2', x: 600, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'q1', symbol: 'a' },
              { from: 'q0', to: 'q0', symbol: 'b' },
              { from: 'q1', to: 'q2', symbol: 'a' },
              { from: 'q1', to: 'q0', symbol: 'b' },
              { from: 'q2', to: 'q2', symbol: 'a' },
              { from: 'q2', to: 'q2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Monitor for forbidden "aa"',
              'q1: last was "a"',
              'q2: found "aa" (trap)',
              'Accept only if never reach q2'
            ]
          }
        ]
      },
      'complex-patterns': {
        name: 'üöÄ Complex Patterns',
        dfas: [
          {
            name: 'Alternating "a" and "b"',
            description: 'Accept strictly alternating strings',
            states: [
              { id: 'q0', x: 200, y: 150, initial: true, accepting: true },
              { id: 'qa', x: 350, y: 100, accepting: true },
              { id: 'qb', x: 350, y: 200, accepting: true },
              { id: 'trap', x: 500, y: 150 }
            ],
            transitions: [
              { from: 'q0', to: 'qa', symbol: 'a' },
              { from: 'q0', to: 'qb', symbol: 'b' },
              { from: 'qa', to: 'trap', symbol: 'a' },
              { from: 'qa', to: 'qb', symbol: 'b' },
              { from: 'qb', to: 'qa', symbol: 'a' },
              { from: 'qb', to: 'trap', symbol: 'b' },
              { from: 'trap', to: 'trap', symbol: 'a' },
              { from: 'trap', to: 'trap', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track last character for alternation',
              'qa: last was "a", qb: last was "b"',
              'Go to trap if same character repeats',
              'Accept only alternating patterns'
            ]
          },
          {
            name: 'More "a"s than "b"s',
            description: 'Accept when #a > #b (DFA approximation)',
            states: [
              { id: 'q0', x: 200, y: 200, initial: true },
              { id: 'q+1', x: 350, y: 150, accepting: true },
              { id: 'q+2', x: 500, y: 100, accepting: true },
              { id: 'q-1', x: 350, y: 250 },
              { id: 'q-2', x: 500, y: 300 }
            ],
            transitions: [
              { from: 'q0', to: 'q+1', symbol: 'a' },
              { from: 'q0', to: 'q-1', symbol: 'b' },
              { from: 'q+1', to: 'q+2', symbol: 'a' },
              { from: 'q+1', to: 'q0', symbol: 'b' },
              { from: 'q+2', to: 'q+2', symbol: 'a' },
              { from: 'q+2', to: 'q+1', symbol: 'b' },
              { from: 'q-1', to: 'q0', symbol: 'a' },
              { from: 'q-1', to: 'q-2', symbol: 'b' },
              { from: 'q-2', to: 'q-1', symbol: 'a' },
              { from: 'q-2', to: 'q-2', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track bounded difference #a - #b',
              'Positive states: more "a"s',
              'Negative states: more "b"s',
              'Limited precision due to finite states'
            ]
          },
          {
            name: 'No three consecutive same',
            description: 'Reject "aaa" and "bbb"',
            states: [
              { id: 'q0', x: 150, y: 200, initial: true, accepting: true },
              { id: 'qa', x: 300, y: 150, accepting: true },
              { id: 'qb', x: 300, y: 250, accepting: true },
              { id: 'qaa', x: 450, y: 100, accepting: true },
              { id: 'qbb', x: 450, y: 300, accepting: true },
              { id: 'trap', x: 600, y: 200 }
            ],
            transitions: [
              { from: 'q0', to: 'qa', symbol: 'a' },
              { from: 'q0', to: 'qb', symbol: 'b' },
              { from: 'qa', to: 'qaa', symbol: 'a' },
              { from: 'qa', to: 'qb', symbol: 'b' },
              { from: 'qb', to: 'qa', symbol: 'a' },
              { from: 'qb', to: 'qbb', symbol: 'b' },
              { from: 'qaa', to: 'trap', symbol: 'a' },
              { from: 'qaa', to: 'qb', symbol: 'b' },
              { from: 'qbb', to: 'qa', symbol: 'a' },
              { from: 'qbb', to: 'trap', symbol: 'b' },
              { from: 'trap', to: 'trap', symbol: 'a' },
              { from: 'trap', to: 'trap', symbol: 'b' }
            ],
            alphabet: ['a', 'b'],
            steps: [
              'Track last two characters',
              'Monitor for three consecutive',
              'Go to trap on third consecutive',
              'Reset pattern on different character'
            ]
          }
        ]
      }
    };

    // Initialize the application
    function initializeApp() {
      populateCategories();
      setupEventHandlers();
      clearVisualization();
      showWelcomeMessage();
      loadSavedDFAs();
    }

    // Populate category dropdown
    function populateCategories() {
      dfaCategory.innerHTML = '<option value="">Choose a category...</option>';
      Object.keys(DFA_LIBRARY).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = DFA_LIBRARY[key].name;
        dfaCategory.appendChild(option);
      });
    }

    // Setup event handlers
    function setupEventHandlers() {
      dfaCategory.addEventListener('change', handleCategoryChange);
      
      // Construction controls
      document.getElementById('prevStepBtn').addEventListener('click', previousStep);
      document.getElementById('nextStepBtn').addEventListener('click', nextStep);
      document.getElementById('restartStepsBtn').addEventListener('click', restartSteps);
      document.getElementById('autoPlayToggle').addEventListener('change', toggleAutoPlay);
      
      // Testing controls
      document.getElementById('testBtn').addEventListener('click', testString);
      document.getElementById('resetBtn').addEventListener('click', resetVisualization);
      
      // Quick actions
      document.getElementById('randomTestBtn').addEventListener('click', generateRandomTest);
      document.getElementById('stepModeBtn').addEventListener('click', () => setAnimationSpeed(2000));
      document.getElementById('fullSpeedBtn').addEventListener('click', () => setAnimationSpeed(500));
      document.getElementById('slowSpeedBtn').addEventListener('click', () => setAnimationSpeed(3000));
      
      // Advanced features
      document.getElementById('customBuilderBtn').addEventListener('click', toggleBuilder);
      document.getElementById('exportBtn').addEventListener('click', exportDFA);
      document.getElementById('saveBtn').addEventListener('click', () => showSaveLoadModal('save'));
      document.getElementById('loadBtn').addEventListener('click', () => showSaveLoadModal('load'));
      
      // Builder controls
      document.getElementById('addStateBtn').addEventListener('click', addState);
      document.getElementById('setInitialBtn').addEventListener('click', setInitialState);
      document.getElementById('toggleAcceptingBtn').addEventListener('click', toggleAcceptingState);
      document.getElementById('addTransitionBtn').addEventListener('click', addTransition);
      document.getElementById('clearDfaBtn').addEventListener('click', clearCustomDFA);
      document.getElementById('validateDfaBtn').addEventListener('click', validateDFA);
      
      // Modal controls
      document.querySelector('.close').addEventListener('click', closeSaveLoadModal);
      document.getElementById('confirmSaveLoad').addEventListener('click', confirmSaveLoad);
      document.getElementById('cancelSaveLoad').addEventListener('click', closeSaveLoadModal);
      
      // Keyboard shortcuts
      testInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') testString();
      });
      
      // SVG click handler for builder mode
      dfaSVG.addEventListener('click', handleSVGClick);
    }

    // Handle category selection
    function handleCategoryChange() {
      const category = dfaCategory.value;
      if (category) {
        showVariations(category);
      } else {
        hideVariations();
        clearVisualization();
        showWelcomeMessage();
      }
    }

    // Show variations for selected category
    function showVariations(categoryKey) {
      const category = DFA_LIBRARY[categoryKey];
      variationsGrid.innerHTML = '';
      
      category.dfas.forEach((dfa, index) => {
        const card = document.createElement('div');
        card.className = 'variation-card';
        card.innerHTML = `
          <div class="variation-title">${dfa.name}</div>
          <div class="variation-desc">${dfa.description}</div>
        `;
        
        card.addEventListener('click', () => {
          document.querySelectorAll('.variation-card').forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          loadDFA(dfa);
        });
        
        variationsGrid.appendChild(card);
      });
      
      variationsContainer.style.display = 'block';
    }

    // Hide variations panel
    function hideVariations() {
      variationsContainer.style.display = 'none';
    }

    // Load and display DFA
    function loadDFA(dfa) {
      CURRENT_DFA = JSON.parse(JSON.stringify(dfa)); // Deep copy
      CONSTRUCTION_STEPS = dfa.steps;
      CURRENT_STEP = -1;
      BUILDER_MODE = false;
      builderPanel.classList.add('builder-hidden');
      
      updateGuide(`üìã ${dfa.name}: ${dfa.description}`);
      visualizeDFA(dfa);
      enableControls();
      
      if (AUTO_PLAY && CONSTRUCTION_STEPS) {
        startConstructionAnimation();
      }
    }

    // Visualize DFA in SVG
    function visualizeDFA(dfa, highlight = {}) {
      const svg = dfaSVG;
      
      // Clear existing content except defs
      const defs = svg.querySelector('defs');
      svg.innerHTML = '';
      svg.appendChild(defs);
      
      if (!dfa || !dfa.states || dfa.states.length === 0) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '400');
        text.setAttribute('y', '200');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('class', 'state-label');
        text.style.fontSize = '18px';
        text.style.fill = '#a0aec0';
        text.textContent = 'No DFA to display';
        svg.appendChild(text);
        return;
      }
      
      // Store positions
      STATE_POSITIONS = {};
      dfa.states.forEach(state => {
        STATE_POSITIONS[state.id] = { x: state.x, y: state.y };
      });
      
      // Draw transitions first
      if (dfa.transitions) {
        dfa.transitions.forEach(transition => {
          drawTransition(transition, highlight.transition === transition);
        });
      }
      
      // Draw states
      dfa.states.forEach(state => {
        drawState(state, highlight.state === state.id);
      });
    }

    // Draw a state
    function drawState(state, isHighlighted) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      // Main circle
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', state.x);
      circle.setAttribute('cy', state.y);
      circle.setAttribute('r', 25);
      circle.setAttribute('class', 'state-circle' + 
        (state.accepting ? ' final' : '') + 
        (isHighlighted ? ' active' : ''));
      circle.setAttribute('data-state-id', state.id);
      g.appendChild(circle);
      
      // Inner circle for accepting states
      if (state.accepting) {
        const innerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        innerCircle.setAttribute('cx', state.x);
        innerCircle.setAttribute('cy', state.y);
        innerCircle.setAttribute('r', 20);
        innerCircle.setAttribute('fill', 'none');
        innerCircle.setAttribute('stroke', '#48bb78');
        innerCircle.setAttribute('stroke-width', '2');
        g.appendChild(innerCircle);
      }
      
      // Initial state arrow
      if (state.initial) {
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arrow.setAttribute('d', `M${state.x - 60} ${state.y} L${state.x - 30} ${state.y}`);
        arrow.setAttribute('class', 'initial-arrow');
        arrow.setAttribute('marker-end', 'url(#arrowhead)');
        dfaSVG.appendChild(arrow);
      }
      
      // State label
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', state.x);
      label.setAttribute('y', state.y);
      label.setAttribute('class', 'state-label');
      label.textContent = state.id;
      g.appendChild(label);
      
      dfaSVG.appendChild(g);
    }

    // Draw a transition
    function drawTransition(transition, isHighlighted) {
      const fromPos = STATE_POSITIONS[transition.from];
      const toPos = STATE_POSITIONS[transition.to];
      
      if (!fromPos || !toPos) return;
      
      if (transition.from === transition.to) {
        drawSelfLoop(fromPos, transition.symbol, isHighlighted);
      } else {
        drawArrow(fromPos, toPos, transition.symbol, isHighlighted);
      }
    }

    // Draw arrow between states
    function drawArrow(from, to, symbol, isHighlighted) {
      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const unitX = dx / distance;
      const unitY = dy / distance;
      
      const startX = from.x + unitX * 30;
      const startY = from.y + unitY * 30;
      const endX = to.x - unitX * 30;
      const endY = to.y - unitY * 30;
      
      // Create curved path
      const midX = (startX + endX) / 2;
      const midY = (startY + endY) / 2;
      const curve = 20;
      const controlX = midX + curve * (-unitY);
      const controlY = midY + curve * unitX;
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M${startX},${startY} Q${controlX},${controlY} ${endX},${endY}`);
      path.setAttribute('class', 'transition-path' + (isHighlighted ? ' active' : ''));
      path.setAttribute('marker-end', isHighlighted ? 'url(#arrowhead-active)' : 'url(#arrowhead)');
      dfaSVG.appendChild(path);
      
      // Add label
      const labelX = controlX;
      const labelY = controlY - 8;
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', labelX);
      label.setAttribute('y', labelY);
      label.setAttribute('class', 'transition-label');
      label.textContent = symbol;
      dfaSVG.appendChild(label);
    }

    // Draw self-loop
    function drawSelfLoop(pos, symbol, isHighlighted) {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 
        `M${pos.x} ${pos.y - 25} 
         C${pos.x + 30} ${pos.y - 50}, ${pos.x - 30} ${pos.y - 50}, ${pos.x} ${pos.y - 25}`);
      path.setAttribute('class', 'transition-path' + (isHighlighted ? ' active' : ''));
      path.setAttribute('marker-end', isHighlighted ? 'url(#arrowhead-active)' : 'url(#arrowhead)');
      dfaSVG.appendChild(path);
      
      // Add label
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', pos.x);
      label.setAttribute('y', pos.y - 60);
      label.setAttribute('class', 'transition-label');
      label.textContent = symbol;
      dfaSVG.appendChild(label);
    }

    // Animation functions
    function* animateString(dfa, input) {
      if (!dfa.states || dfa.states.length === 0) {
        yield { error: 'No states in DFA' };
        return;
      }
      
      const initialState = dfa.states.find(s => s.initial);
      if (!initialState) {
        yield { error: 'No initial state defined' };
        return;
      }
      
      let currentState = initialState.id;
      
      yield { state: currentState, step: `Starting at state ${currentState}` };
      
      for (let i = 0; i < input.length; i++) {
        const symbol = input[i];
        const transition = dfa.transitions?.find(t => 
          t.from === currentState && t.symbol === symbol
        );
        
        if (!transition) {
          yield { 
            error: `No transition from ${currentState} on '${symbol}'`,
            state: currentState
          };
          return;
        }
        
        yield { 
          transition: transition,
          step: `Reading '${symbol}': ${transition.from} ‚Üí ${transition.to}`
        };
        
        currentState = transition.to;
        yield { 
          state: currentState,
          step: `Now in state ${currentState}`
        };
      }
      
      const finalState = dfa.states.find(s => s.id === currentState);
      const accepted = finalState && finalState.accepting;
      
      yield {
        state: currentState,
        result: accepted ? 'accepted' : 'rejected',
        step: accepted ? 
          `‚úÖ String accepted! (${currentState} is accepting)` :
          `‚ùå String rejected! (${currentState} is not accepting)`
      };
    }

    // Test string function
    function testString() {
      if (!CURRENT_DFA) {
        showOutput('Please select a DFA first!', 'error');
        return;
      }
      
      const input = testInput.value.trim();
      
      // Validate input against alphabet
      if (CURRENT_DFA.alphabet) {
        for (const char of input) {
          if (!CURRENT_DFA.alphabet.includes(char)) {
            showOutput(`Invalid character '${char}'. Use only: ${CURRENT_DFA.alphabet.join(', ')}`, 'error');
            return;
          }
        }
      }
      
      // Start animation
      ANIMATION_GENERATOR = animateString(CURRENT_DFA, input);
      showOutput(`üé¨ Testing string: "${input}"`, 'info');
      nextAnimationStep();
    }

    // Animation step
    function nextAnimationStep() {
      if (!ANIMATION_GENERATOR) return;
      
      const { value, done } = ANIMATION_GENERATOR.next();
      if (done || !value) return;
      
      if (value.error) {
        showOutput(value.error, 'error');
        visualizeDFA(CURRENT_DFA, { state: value.state });
        ANIMATION_GENERATOR = null;
        return;
      }
      
      if (value.result) {
        showOutput(value.step, value.result === 'accepted' ? 'success' : 'error');
        outputDisplay.classList.add('animate-result');
        setTimeout(() => outputDisplay.classList.remove('animate-result'), 500);
        visualizeDFA(CURRENT_DFA, { state: value.state });
        ANIMATION_GENERATOR = null;
        return;
      }
      
      // Update visualization
      const highlight = {};
      if (value.state) highlight.state = value.state;
      if (value.transition) highlight.transition = value.transition;
      
      visualizeDFA(CURRENT_DFA, highlight);
      updateGuide(value.step || '');
      
      setTimeout(nextAnimationStep, ANIMATION_SPEED);
    }

    // Construction animation functions
    function startConstructionAnimation() {
      CURRENT_STEP = 0;
      showConstructionStep();
    }

    function showConstructionStep() {
      if (!CONSTRUCTION_STEPS || CURRENT_STEP < 0 || CURRENT_STEP >= CONSTRUCTION_STEPS.length) {
        updateGuide('‚úÖ Construction complete! Ready to test strings.');
        visualizeDFA(CURRENT_DFA);
        return;
      }
      
      const step = CONSTRUCTION_STEPS[CURRENT_STEP];
      updateGuide(`üîß Step ${CURRENT_STEP + 1}/${CONSTRUCTION_STEPS.length}: ${step}`);
      
      if (AUTO_PLAY && CURRENT_STEP < CONSTRUCTION_STEPS.length - 1) {
        STEP_TIMEOUT = setTimeout(() => {
          CURRENT_STEP++;
          showConstructionStep();
        }, 2000);
      }
    }

    // Control functions
    function previousStep() {
      if (CURRENT_STEP > 0) {
        CURRENT_STEP--;
        clearTimeout(STEP_TIMEOUT);
        showConstructionStep();
      }
    }

    function nextStep() {
      if (CURRENT_STEP < CONSTRUCTION_STEPS.length - 1) {
        CURRENT_STEP++;
        clearTimeout(STEP_TIMEOUT);
        showConstructionStep();
      }
    }

    function restartSteps() {
      CURRENT_STEP = -1;
      clearTimeout(STEP_TIMEOUT);
      if (AUTO_PLAY) {
        startConstructionAnimation();
      } else {
        updateGuide('üìã Ready to start construction. Click Next Step to begin.');
      }
    }

    function toggleAutoPlay() {
      AUTO_PLAY = document.getElementById('autoPlayToggle').checked;
      if (AUTO_PLAY && CURRENT_STEP >= 0 && CURRENT_STEP < CONSTRUCTION_STEPS.length - 1) {
        STEP_TIMEOUT = setTimeout(() => {
          CURRENT_STEP++;
          showConstructionStep();
        }, 2000);
      } else {
        clearTimeout(STEP_TIMEOUT);
      }
    }

    // Advanced features
    function toggleBuilder() {
      BUILDER_MODE = !BUILDER_MODE;
      if (BUILDER_MODE) {
        builderPanel.classList.remove('builder-hidden');
        if (!CURRENT_DFA || CURRENT_DFA.states.length === 0) {
          initializeCustomDFA();
        }
        updateGuide('üõ†Ô∏è Builder mode activated. Click on the canvas to add states, or use the controls to build your DFA.');
      } else {
        builderPanel.classList.add('builder-hidden');
        updateGuide('üéØ Builder mode deactivated. Select a preset DFA to continue learning.');
      }
    }

    function initializeCustomDFA() {
      CURRENT_DFA = {
        name: 'Custom DFA',
        description: 'User-created DFA',
        states: [],
        transitions: [],
        alphabet: ['a', 'b'],
        steps: []
      };
      visualizeDFA(CURRENT_DFA);
    }

    function addState() {
      const stateId = document.getElementById('stateId').value.trim();
      if (!stateId) {
        showOutput('Please enter a state ID', 'error');
        return;
      }
      
      if (!CURRENT_DFA) initializeCustomDFA();
      
      if (CURRENT_DFA.states.find(s => s.id === stateId)) {
        showOutput('State already exists', 'error');
        return;
      }
      
      // Find good position for new state
      const x = 200 + (CURRENT_DFA.states.length % 3) * 200;
      const y = 150 + Math.floor(CURRENT_DFA.states.length / 3) * 100;
      
      const newState = {
        id: stateId,
        x: x,
        y: y,
        initial: CURRENT_DFA.states.length === 0, // First state is initial
        accepting: false
      };
      
      CURRENT_DFA.states.push(newState);
      document.getElementById('stateId').value = '';
      visualizeDFA(CURRENT_DFA);
      showOutput(`Added state ${stateId}`, 'success');
    }

    function setInitialState() {
      if (!SELECTED_STATE) {
        showOutput('Please select a state first', 'error');
        return;
      }
      
      // Remove initial from all states
      CURRENT_DFA.states.forEach(s => s.initial = false);
      // Set selected as initial
      const state = CURRENT_DFA.states.find(s => s.id === SELECTED_STATE);
      if (state) {
        state.initial = true;
        visualizeDFA(CURRENT_DFA);
        showOutput(`Set ${SELECTED_STATE} as initial state`, 'success');
      }
    }

    function toggleAcceptingState() {
      if (!SELECTED_STATE) {
        showOutput('Please select a state first', 'error');
        return;
      }
      
      const state = CURRENT_DFA.states.find(s => s.id === SELECTED_STATE);
      if (state) {
        state.accepting = !state.accepting;
        visualizeDFA(CURRENT_DFA);
        showOutput(`${SELECTED_STATE} is now ${state.accepting ? 'accepting' : 'non-accepting'}`, 'success');
      }
    }

    function addTransition() {
      const from = document.getElementById('fromState').value.trim();
      const to = document.getElementById('toState').value.trim();
      const symbol = document.getElementById('transitionSymbol').value.trim();
      
      if (!from || !to || !symbol) {
        showOutput('Please fill all transition fields', 'error');
        return;
      }
      
      if (!CURRENT_DFA.states.find(s => s.id === from)) {
        showOutput(`State ${from} does not exist`, 'error');
        return;
      }
      
      if (!CURRENT_DFA.states.find(s => s.id === to)) {
        showOutput(`State ${to} does not exist`, 'error');
        return;
      }
      
      if (!CURRENT_DFA.alphabet.includes(symbol)) {
        showOutput(`Symbol ${symbol} not in alphabet`, 'error');
        return;
      }
      
      // Check for duplicate transition
      const exists = CURRENT_DFA.transitions.find(t => 
        t.from === from && t.symbol === symbol
      );
      if (exists) {
        showOutput('Transition already exists (DFA must be deterministic)', 'error');
        return;
      }
      
      CURRENT_DFA.transitions.push({ from, to, symbol });
      document.getElementById('fromState').value = '';
      document.getElementById('toState').value = '';
      document.getElementById('transitionSymbol').value = '';
      
      visualizeDFA(CURRENT_DFA);
      showOutput(`Added transition ${from} ‚Üí ${to} on '${symbol}'`, 'success');
    }

    function clearCustomDFA() {
      if (confirm('Clear all states and transitions?')) {
        initializeCustomDFA();
        SELECTED_STATE = null;
        showOutput('DFA cleared', 'info');
      }
    }

    function validateDFA() {
      if (!CURRENT_DFA || !CURRENT_DFA.states || CURRENT_DFA.states.length === 0) {
        showOutput('No DFA to validate', 'error');
        return;
      }
      
      const errors = [];
      
      // Check for initial state
      const initialStates = CURRENT_DFA.states.filter(s => s.initial);
      if (initialStates.length === 0) {
        errors.push('No initial state defined');
      } else if (initialStates.length > 1) {
        errors.push('Multiple initial states (should be exactly one)');
      }
      
      // Check completeness for each state and symbol
      CURRENT_DFA.states.forEach(state => {
        CURRENT_DFA.alphabet.forEach(symbol => {
          const transitions = CURRENT_DFA.transitions.filter(t => 
            t.from === state.id && t.symbol === symbol
          );
          if (transitions.length === 0) {
            errors.push(`Missing transition from ${state.id} on '${symbol}'`);
          } else if (transitions.length > 1) {
            errors.push(`Multiple transitions from ${state.id} on '${symbol}' (non-deterministic)`);
          }
        });
      });
      
      if (errors.length === 0) {
        showOutput('‚úÖ DFA is valid and complete!', 'success');
      } else {
        showOutput(`‚ùå DFA validation failed: ${errors.join(', ')}`, 'error');
      }
    }

    function handleSVGClick(event) {
      if (!BUILDER_MODE) return;
      
      const rect = dfaSVG.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      // Convert to SVG coordinates
      const svgX = (x / rect.width) * 800;
      const svgY = (y / rect.height) * 400;
      
      // Check if clicked on existing state
      const clickedState = findStateAt(svgX, svgY);
      if (clickedState) {
        SELECTED_STATE = clickedState.id;
        showOutput(`Selected state ${clickedState.id}`, 'info');
        document.getElementById('setInitialBtn').disabled = false;
        document.getElementById('toggleAcceptingBtn').disabled = false;
        return;
      }
      
      // Create new state at click position
      const stateId = `q${CURRENT_DFA.states.length}`;
      const newState = {
        id: stateId,
        x: svgX,
        y: svgY,
        initial: CURRENT_DFA.states.length === 0,
        accepting: false
      };
      
      CURRENT_DFA.states.push(newState);
      visualizeDFA(CURRENT_DFA);
      showOutput(`Added state ${stateId} at (${Math.round(svgX)}, ${Math.round(svgY)})`, 'success');
    }

    function findStateAt(x, y) {
      return CURRENT_DFA.states.find(state => {
        const dx = state.x - x;
        const dy = state.y - y;
        return Math.sqrt(dx * dx + dy * dy) <= 25; // State radius
      });
    }

    // Save/Load functionality
    function showSaveLoadModal(mode) {
      const modal = document.getElementById('saveLoadModal');
      const title = document.getElementById('modalTitle');
      const confirmBtn = document.getElementById('confirmSaveLoad');
      
      if (mode === 'save') {
        title.textContent = 'Save DFA';
        confirmBtn.textContent = 'Save';
        if (CURRENT_DFA) {
          document.getElementById('dfaData').value = JSON.stringify(CURRENT_DFA, null, 2);
        }
      } else {
        title.textContent = 'Load DFA';
        confirmBtn.textContent = 'Load';
        document.getElementById('dfaData').value = '';
      }
      
      modal.style.display = 'block';
    }

    function closeSaveLoadModal() {
      document.getElementById('saveLoadModal').style.display = 'none';
    }

    function confirmSaveLoad() {
      const mode = document.getElementById('modalTitle').textContent.includes('Save') ? 'save' : 'load';
      const name = document.getElementById('dfaName').value.trim();
      const data = document.getElementById('dfaData').value.trim();
      
      if (mode === 'save') {
        if (!name) {
          showOutput('Please enter a name for the DFA', 'error');
          return;
        }
        
        if (!CURRENT_DFA) {
          showOutput('No DFA to save', 'error');
          return;
        }
        
        const savedDfas = JSON.parse(localStorage.getItem('savedDFAs') || '{}');
        savedDfas[name] = CURRENT_DFA;
        localStorage.setItem('savedDFAs', JSON.stringify(savedDfas));
        
        showOutput(`DFA saved as "${name}"`, 'success');
      } else {
        if (!data) {
          showOutput('Please enter DFA data', 'error');
          return;
        }
        
        try {
          const loadedDFA = JSON.parse(data);
          if (!loadedDFA.states || !Array.isArray(loadedDFA.states)) {
            throw new Error('Invalid DFA format');
          }
          
          CURRENT_DFA = loadedDFA;
          visualizeDFA(CURRENT_DFA);
          updateGuide(`üìÅ Loaded: ${loadedDFA.name || 'Custom DFA'}`);
          showOutput('DFA loaded successfully', 'success');
        } catch (error) {
          showOutput('Invalid DFA data format', 'error');
          return;
        }
      }
      
      closeSaveLoadModal();
    }

    function loadSavedDFAs() {
      // This could populate a dropdown of saved DFAs in the future
      const savedDfas = JSON.parse(localStorage.getItem('savedDFAs') || '{}');
      console.log('Saved DFAs:', Object.keys(savedDfas));
    }

    function exportDFA() {
      if (!CURRENT_DFA) {
        showOutput('No DFA to export', 'error');
        return;
      }
      
      const dataStr = JSON.stringify(CURRENT_DFA, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${CURRENT_DFA.name || 'dfa'}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      showOutput('DFA exported successfully', 'success');
    }

    // Utility functions
    function enableControls() {
      document.getElementById('prevStepBtn').disabled = false;
      document.getElementById('nextStepBtn').disabled = false;
      document.getElementById('restartStepsBtn').disabled = false;
      document.getElementById('autoPlayToggle').disabled = false;
    }

    function updateGuide(text) {
      guideContent.innerHTML = text;
    }

    function showOutput(text, type = '') {
      outputDisplay.textContent = text;
      outputDisplay.className = 'output-display' + (type ? ` ${type}` : '');
    }

    function clearVisualization() {
      const svg = dfaSVG;
      const defs = svg.querySelector('defs');
      svg.innerHTML = '';
      svg.appendChild(defs);
      
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', '400');
      text.setAttribute('y', '200');
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('class', 'state-label');
      text.style.fontSize = '18px';
      text.style.fill = '#a0aec0';
      text.textContent = 'Select a DFA to visualize';
      svg.appendChild(text);
    }

    function showWelcomeMessage() {
      updateGuide('üéØ Welcome to the Advanced DFA Learning Studio! Select a category to explore different types of automata.');
      showOutput('Ready to explore the world of finite automata!', '');
    }

    function resetVisualization() {
      if (CURRENT_DFA) {
        visualizeDFA(CURRENT_DFA);
        showOutput('Visualization reset', '');
        updateGuide(`üìã ${CURRENT_DFA.name}: ${CURRENT_DFA.description || ''}`);
      }
      ANIMATION_GENERATOR = null;
    }

    function generateRandomTest() {
      if (!CURRENT_DFA || !CURRENT_DFA.alphabet) {
        showOutput('Please select a DFA first!', 'error');
        return;
      }
      
      const length = Math.floor(Math.random() * 8) + 1;
      let randomString = '';
      for (let i = 0; i < length; i++) {
        const randomChar = CURRENT_DFA.alphabet[Math.floor(Math.random() * CURRENT_DFA.alphabet.length)];
        randomString += randomChar;
      }
      
      testInput.value = randomString;
      testString();
    }

    function setAnimationSpeed(speed) {
      ANIMATION_SPEED = speed;
      const speedName = speed === 500 ? 'Fast' : speed === 2000 ? 'Step' : speed === 3000 ? 'Slow' : 'Normal';
      showOutput(`Animation speed: ${speedName}`, 'info');
    }

    // Initialize app when page loads
    window.addEventListener('load', initializeApp);
  </script>
</body>
</html>